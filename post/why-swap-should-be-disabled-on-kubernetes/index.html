<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
    
    
      <link href="/css/fonts.css" rel="stylesheet" type="text/css">
    
  

  
  <title>Why Swap should be disabled on Kubernetes</title>

  
  
  <link rel="stylesheet" href="/css/hugo-octopress.css">

  
  

  
    <link rel="stylesheet" href="/css/fork-awesome.min.css">
  

  
  <link href="https://leizhilong.github.io/favicon.png" rel="icon">

  
  

  <meta name="description" content="" />
  <meta name="keywords" content="[Lei Zhilong leizhilong kubernetes linux container golang mobile app back-end service blog]">
  <meta name="author" content="leizhilong">

  
  <meta name="generator" content="Hugo 0.71.1" />

  
  

  
  
    

  
  
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image:src" content="https://leizhilong.github.io/post/why-swap-should-be-disabled-on-kubernetes/.png"/>
  
  
  <meta name="twitter:title" content="Why Swap should be disabled on Kubernetes"/>
  <meta name="twitter:description" content="Issue Description
Since Kubernetes 1.8, a kubelet flag fail-swap-on has been set to a default value true, which means that swap is not supported by default on Kubernetes. SWAP is used on Unix and Linux by default since they were born. People are astonished to learn that swap has to be disabled on Kubernetes which is supposed to be able to facilitate the full ablity of Linux system. There are several issues on github talking about this change, unfortunately no pregress has been made officially. I&rsquo;m trying to understand the whole story and here&rsquo;s some information I found.

(PS., the kubelet&rsquo;s flag fail-swap-on was deprecated and moved to the config file specified by the --config flag. See https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/ for more information.)

Why
As I understand it, the reason of disabling swap is that the whole Kuberentes resource QoS(Quality of Service) policy implementation is designed on the base of explicitly resource limitation and scheduling. As we all konw, there are 3 classes of QoS for each Pod on Kuberentes:

Best-Effort pods will be treated as lowest priority. Processes in these pods are the first to get killed if the system runs out of memory. These containers can use any amount of free memory in the node though.
Guaranteed pods are considered top-priority and are guaranteed to not be killed until they exceed their limits, or if the system is under memory pressure and there are no lower priority containers that can be evicted.
Burstable pods have some form of minimal resource guarantee, but can use more resources when available. Under system memory pressure, these containers are more likely to be killed once they exceed their requests and no Best-Effort pods exist.

Accroding to this design, Guaranteed pods should never have to use swap and Best-Effort pods should only run on nodes with free memory. While Burstable pods exceed their memory requests, they should either be allocated with more memory within the limits if it&rsquo;s possible for  the underlay nodes to spare or be killed under pressure. All of these pods should not be faced with the decision whether or not to use swap.
Of course, if kubelet is smart enough and linux kernel provides deterministic isolation behavior for swap spaces, swap might be a good option. But even if it&rsquo;s technically possible, there definitely tons of job to do. &ldquo;Support for swap is non-trivial&rdquo;, says Kubernetes community. Considering the effort have to make swap usable and the gains it could realize, optimizing for swap is given much lower priority compared to improving reliability around pressure detection, optimizing issues around latency or other similar features. That&rsquo;s why the Kuberentes issue #53533 on Github has been open for quite a longtime. There is even a description in official desgin documentation to address this issue

The current QoS policy assumes that swap is disabled. If swap is enabled, then resource guarantees (for pods that specify resource requirements) will not hold. For example, suppose 2 guaranteed pods have reached their memory limit. They can continue allocating memory by utilizing disk space. Eventually, if there isn&rsquo;t enough swap space, processes in the pods might get killed. The node must take into account swap space explicitly for providing deterministic isolation behavior.

To summarize, the lack of swap support for Kubernetes lies in the fact that swap usage is not even expected in Kubernetes and there are enormous work to be done before swap can be used in product grade. IMHO, these work are no just about Kubernets itself but enven more about Linux kernel. It might be problem for the Kubernetes community to find a strong motivation to tackle this issue considering the huge amount of efforts.
Arguement
Even though there is still a longtime to expected swap get official supported, the communities have been providing more and more scenarios that prove the necessarity. One of the cases is that some of the applications are designed make use of swap to handle tasks using up 10 or 100 more times memory in peak time than handling normal tasks. In this case, it might be impossible to for user to prepare enough phisycal memory since the costs might be unacceptable. In this scenario, the need of swap is crucial and the absence of swap support might drive users away from Kubernetes.
In my case, I&rsquo;ve been experiencing some strange behaviors of my workload containers in which MySQL server runs with swap enabled and resources guaranteed. Since we have been using kubernetes for more than 2 years, the Kubernetes version is quite old and disabling swap is still not a default setting. What we have inspected is that even if there are sufficient memory for the workload, the usage swap keeps going up slowly util the process get killed by OOMKiller.I guess that might be one of the reasons handling swap is pretty complicated.
As far as I&rsquo;m concerned, the support of Swap is not just about turning on some flags of Kubernetes but involves with how to establish a whole michanism of swap utilization, limitation, regulation and isolation from Linux kernel，Kubernetes to application layer. Before that can be done, I would argue that people should be cautious to run workloads in Kubernetes with swap on.
Reference
Here&rsquo;s some links to the community discussions. Jump in, it&rsquo;s still goning.

https://github.com/kubernetes/kubernetes/issues/53533
https://github.com/kubernetes/kubernetes/issues/7294
"/>
  
  <meta name="twitter:domain" content="leizhilong"/>
  <meta name="twitter:creator" content="@leizhilong"/>

  
</head>
<body>


<header role="banner">
<hgroup>
  
  <h1><a href="https://leizhilong.github.io/">Lei Zhilong&#39;s Blog</a></h1>
    <h2>Just some tech notes and thoughts, feel free to explore</h2>
</hgroup></header>


<nav role="navigation">
<fieldset class="mobile-nav">
  
  <select onchange="location = this.value;">
    <option value="">Navigate…</option>
      
        <option value="https://leizhilong.github.io/post/">» Posts</option>
      
        <option value="https://leizhilong.github.io/categories/">» Categories</option>
      
        <option value="https://leizhilong.github.io/tags/">» Tags</option>
      
        <option value="https://leizhilong.github.io/about/">» About Me</option>
      
  </select>
</fieldset>


<ul class="main-navigation">
  
  
    
      <li><a href="https://leizhilong.github.io/post/" title="Posts" >Posts</a></li>
    
  
    
      <li><a href="https://leizhilong.github.io/categories/" title="Categories" >Categories</a></li>
    
  
    
      <li><a href="https://leizhilong.github.io/tags/" title="Tags" >Tags</a></li>
    
  
    
      <li><a href="https://leizhilong.github.io/about/" title="About Me" >About Me</a></li>
    
  
</ul>

<ul class="subscription">
  
    
        <a href="https://leizhilong.github.io/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>
    
  
</ul>


  <form action="https://www.google.com/search" method="get" target="_blank">
    <fieldset role="search">
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      <input type="hidden" name="q" value="site:https://leizhilong.github.io/" />
    </fieldset>
  </form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
  <p class="meta">Dec 10, 2018
     - 5 minute read 
    

    
    
      - <a class="label" href="https://leizhilong.github.io/categories/kubernetes/">Kubernetes </a>
    
  </p>
  <h1 class="entry-title">
     Why Swap should be disabled on Kubernetes 
  </h1>
</header>


        <div class="entry-content">
          
          
          
            <nav id="TableOfContents">
  <ul>
    <li><a href="#issue-description">Issue Description</a></li>
    <li><a href="#why">Why</a></li>
    <li><a href="#arguement">Arguement</a></li>
    <li><a href="#reference">Reference</a></li>
  </ul>
</nav>
          
          <h2 id="issue-description">Issue Description</h2>
<p>Since Kubernetes 1.8, a kubelet flag <code>fail-swap-on</code> has been set to a default value <code>true</code>, which means that swap is not supported by default on Kubernetes. SWAP is used on Unix and Linux by default since they were born. People are astonished to learn that swap has to be disabled on Kubernetes which is supposed to be able to facilitate the full ablity of Linux system. There are several issues on github talking about this change, unfortunately no pregress has been made officially. I&rsquo;m trying to understand the whole story and here&rsquo;s some information I found.</p>
<blockquote>
<p>(PS., the kubelet&rsquo;s flag <code>fail-swap-on</code> was deprecated and moved to the config file specified by the <code>--config</code> flag. See <a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/">https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/</a> for more information.)</p>
</blockquote>
<h2 id="why">Why</h2>
<p>As I understand it, the reason of disabling swap is that the whole Kuberentes resource QoS(Quality of Service) policy implementation is designed on the base of explicitly resource limitation and scheduling. As we all konw, there are 3 classes of QoS for each Pod on Kuberentes:</p>
<ul>
<li><code>Best-Effort</code> pods will be treated as lowest priority. Processes in these pods are the first to get killed if the system runs out of memory. These containers can use any amount of free memory in the node though.</li>
<li><code>Guaranteed</code> pods are considered top-priority and are guaranteed to not be killed until they exceed their limits, or if the system is under memory pressure and there are no lower priority containers that can be evicted.</li>
<li><code>Burstable</code> pods have some form of minimal resource guarantee, but can use more resources when available. Under system memory pressure, these containers are more likely to be killed once they exceed their requests and no Best-Effort pods exist.</li>
</ul>
<p>Accroding to this design, <code>Guaranteed</code> pods should never have to use swap and <code>Best-Effort</code> pods should only run on nodes with free memory. While <code>Burstable</code> pods exceed their memory requests, they should either be allocated with more memory within the limits if it&rsquo;s possible for  the underlay nodes to spare or be killed under pressure. All of these pods should not be faced with the decision whether or not to use swap.</p>
<p>Of course, if kubelet is smart enough and linux kernel provides deterministic isolation behavior for swap spaces, swap might be a good option. But even if it&rsquo;s technically possible, there definitely tons of job to do. &ldquo;<code>Support for swap is non-trivial</code>&rdquo;, says Kubernetes community. Considering the effort have to make swap usable and the gains it could realize, optimizing for swap is given much lower priority compared to improving reliability around pressure detection, optimizing issues around latency or other similar features. That&rsquo;s why the Kuberentes issue <a href="https://github.com/kubernetes/kubernetes/issues/53533">#53533</a> on Github has been open for quite a longtime. There is even a <a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md#support-for-swap">description</a> in official desgin documentation to address this issue</p>
<blockquote>
<p>The current QoS policy assumes that swap is disabled. If swap is enabled, then resource guarantees (for pods that specify resource requirements) will not hold. For example, suppose 2 guaranteed pods have reached their memory limit. They can continue allocating memory by utilizing disk space. Eventually, if there isn&rsquo;t enough swap space, processes in the pods might get killed. The node must take into account swap space explicitly for providing deterministic isolation behavior.</p>
</blockquote>
<p>To summarize, the lack of swap support for Kubernetes lies in the fact that swap usage is not even expected in Kubernetes and there are enormous work to be done before swap can be used in product grade. IMHO, these work are no just about Kubernets itself but enven more about Linux kernel. It might be problem for the Kubernetes community to find a strong motivation to tackle this issue considering the huge amount of efforts.</p>
<h2 id="arguement">Arguement</h2>
<p>Even though there is still a longtime to expected swap get official supported, the communities have been providing more and more scenarios that prove the necessarity. One of the cases is that some of the applications are designed make use of swap to handle tasks using up 10 or 100 more times memory in peak time than handling normal tasks. In this case, it might be impossible to for user to prepare enough phisycal memory since the costs might be unacceptable. In this scenario, the need of swap is crucial and the absence of swap support might drive users away from Kubernetes.</p>
<p>In my case, I&rsquo;ve been experiencing some strange behaviors of my workload containers in which MySQL server runs with swap enabled and resources guaranteed. Since we have been using kubernetes for more than 2 years, the Kubernetes version is quite old and disabling swap is still not a default setting. What we have inspected is that even if there are sufficient memory for the workload, the usage swap keeps going up slowly util the process get killed by OOMKiller.I guess that might be one of the reasons handling swap is pretty complicated.</p>
<p>As far as I&rsquo;m concerned, the support of Swap is not just about turning on some flags of Kubernetes but involves with how to establish a whole michanism of swap utilization, limitation, regulation and isolation from Linux kernel，Kubernetes to application layer. Before that can be done, I would argue that people should be cautious to run workloads in Kubernetes with swap on.</p>
<h2 id="reference">Reference</h2>
<p>Here&rsquo;s some links to the community discussions. Jump in, it&rsquo;s still goning.</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/issues/53533">https://github.com/kubernetes/kubernetes/issues/53533</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/7294">https://github.com/kubernetes/kubernetes/issues/7294</a></li>
</ul>
        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">leizhilong</span></span>
    
    <time>Dec 10, 2018</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="https://leizhilong.github.io/tags/swap">Swap</a>  <a class="category" href="https://leizhilong.github.io/tags/kubernetes">Kubernetes</a>  
    
    </span>
  </p>

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://leizhilong.github.io/post/case-study-swapoff-cannot-allocate-memory/" title="Case Study: Swapoff Cannot Allocate Memory">Case Study: Swapoff Cannot Allocate Memory</a>
    

    
  </p>
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Who am I?</h1>
    

    <p>
      
        Hi, Lei Zhilong here.
<!-- raw HTML omitted -->
I am based in Shanghai and focus on technology about Kubernetes, Linux Containers, Mobile App back-end service (Java) and Golang application development.
<!-- raw HTML omitted -->
Here I keep my notes and thoughts about things I&rsquo;m interested in. If you want to know more or talk to me, click on <a href="/about/">About Me</a> or contact me via <a href="https://twitter.com/leizhilong">Twitter</a>.
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/leizhilong/" title="https://github.com/leizhilong/"><i class="fa fa-github fa-3x"></i></a>
      
      
      <a target="_blank" href="https://twitter.com/leizhilong/" title="https://twitter.com/leizhilong/"><i class="fa fa-twitter fa-3x"></i></a>
      
         
      
      <a target="_blank" href="https://www.linkedin.com/in/leizhilong/" title="https://www.linkedin.com/in/leizhilong/"><i class="fa fa-linkedin fa-3x"></i></a>
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Categories</h1>
        
        
          <li>
            <a href="https://leizhilong.github.io/categories/go/" title="Golang" >Golang</a>
          </li>
        
          <li>
            <a href="https://leizhilong.github.io/categories/kubernetes/" title="Kubernetes" >Kubernetes</a>
          </li>
        
          <li>
            <a href="https://leizhilong.github.io/categories/container/" title="Container" >Container</a>
          </li>
        
          <li>
            <a href="https://leizhilong.github.io/categories/linux/" title="Linux" >Linux</a>
          </li>
        
          <li>
            <a href="https://leizhilong.github.io/categories/frontend/" title="Frontend" >Frontend</a>
          </li>
        
      </section>
    
  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
          
            
          
            
              <li class="post">
                <a href="/post/why-swap-should-be-disabled-on-kubernetes/">Why Swap should be disabled on Kubernetes</a>
              </li>
            
          
        </ul>
      </section>
    
  
</aside>

  </div>
</div>

    <footer role="contentinfo">
      <p>Copyright &copy; 2020 leizhilong - <a href="https://leizhilong.github.io/license/">License</a> -
        <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
      </p>
    </footer>

    
    
    

    
  </body>
</html>

